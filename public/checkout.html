<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyShop - Checkout</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .checkout-container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .summary-box, .shipping-box { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; }
    .summary-row { display: flex; justify-content: space-between; margin: 0.8rem 0; font-size: 1.1rem; }
    .grand-total { font-size: 1.4rem; font-weight: bold; border-top: 2px solid #333; padding-top: 1rem; margin-top: 1rem; }
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group textarea { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
    .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-right: 1rem; }
    .btn-save { background: #6c757d; color: white; }
    .btn-save:hover { background: #5a6268; }
    .btn-continue { background: #007bff; color: white; }
    .btn-continue:hover { background: #0056b3; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <header>
    <nav class="navbar">
      <div class="logo">MyShop</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
      <div class="nav-right">
        <a href="cart.html" class="cart-link">Cart <span id="cart-count">0</span></a>
        <span id="user-status">Guest</span>
        <button id="logout-btn" style="display:none;">Logout</button>
        <a href="login.html" id="login-link">Login / Register</a>
      </div>
    </nav>
  </header>

  <main class="checkout-container">
    <h1>Checkout</h1>

    <div id="checkout-summary" class="summary-box">
      <h3>Order Summary</h3>
      <div id="items-list"></div>
      <div class="summary-row"><span>Subtotal</span><span id="subtotal">₹0.00</span></div>
      <div class="grand-total"><span>Total</span><span id="grand-total">₹0.00</span></div>
    </div>

    <div class="shipping-box">
      <h3>Shipping Address</h3>

      <!-- Saved addresses dropdown -->
      <div id="saved-addresses" style="margin-bottom:1.5rem; display:none;">
        <label>Select saved address:</label>
        <select id="address-select">
          <option value="">-- Choose saved address --</option>
        </select>
      </div>

      <form id="shipping-form">
        <div class="form-group"><label for="fullName">Full Name *</label><input type="text" id="fullName" required></div>
        <div class="form-group"><label for="phone">Phone Number *</label><input type="tel" id="phone" required pattern="[0-9]{10}"></div>
        <div class="form-group"><label for="address">Street Address *</label><textarea id="address" rows="3" required></textarea></div>
        <div class="form-group"><label for="city">City *</label><input type="text" id="city" required></div>
        <div class="form-group"><label for="pincode">PIN Code *</label><input type="text" id="pincode" required pattern="[0-9]{6}"></div>
        <div class="form-group"><label for="state">State *</label><input type="text" id="state" required value="Karnataka" readonly></div>

        <div style="margin-top:1.5rem;">
          <button type="button" id="save-address-btn" class="btn btn-save">Save Address</button>
          <button type="button" id="continue-to-payment" class="btn btn-continue">Continue to Payment</button>
        </div>
      </form>
    </div>
  </main>

  <script src="js/main.js"></script>
  <script src="js/cart.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof updateCartCount === 'function') updateCartCount();

    // Cart summary code...
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let subtotal = 0;
    const itemsList = document.getElementById('items-list');

    if (cart.length === 0) {
      document.getElementById('checkout-summary').style.display = 'none';
      return;
    }

    cart.forEach(item => {
      const itemTotal = item.price * item.quantity;
      subtotal += itemTotal;
      const div = document.createElement('div');
      div.innerHTML = `${item.name} × ${item.quantity} <span style="float:right;">₹${itemTotal.toFixed(2)}</span>`;
      itemsList.appendChild(div);
    });

    document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById('grand-total').textContent = `₹${subtotal.toFixed(2)}`;

    localStorage.setItem('checkoutSubtotal', subtotal.toFixed(2));

    // Debug token
    const token = localStorage.getItem('token');
    console.log('Token for request:', token ? 'Present (length: ' + token.length + ')' : 'MISSING - login required');

    // Save address
    document.getElementById('save-address-btn').addEventListener('click', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        alert("Please login first - no token found");
        return window.location.href = 'login.html';
      }

      const data = {
        fullName: document.getElementById('fullName').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        city: document.getElementById('city').value.trim(),
        pincode: document.getElementById('pincode').value.trim(),
        state: document.getElementById('state').value.trim()
      };

      if (Object.values(data).some(v => !v)) {
        alert("Fill all fields");
        return;
      }

      console.log("Sending to backend:", data);

      try {
        const res = await fetch('/api/addresses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        console.log('Response status:', res.status);

        const text = await res.text();  // Read as text first (safe)
        console.log('Raw server response:', text || '[empty response body]');

        let responseData;
        try {
          responseData = JSON.parse(text);
        } catch (parseErr) {
          throw new Error('Server sent invalid/empty response: ' + text.substring(0, 200));
        }

        if (!res.ok) {
          throw new Error(responseData.message || `Server error ${res.status}`);
        }

        console.log('Success - saved address:', responseData);
        alert("Address saved successfully! ID: " + responseData._id);
        loadSavedAddresses();
      } catch (err) {
        console.error('Full save error:', err);
        alert("Failed to save address: " + err.message);
      }
    });

    // Continue to payment...
  });

  async function loadSavedAddresses() {
    // ... your load function ...
  }
</script>
</body>
</html>